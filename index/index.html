<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Realtime Group Chat ‚Äî Demo</title>
  <link rel="icon" href="data:;base64,iVBORw0KGgo=">
  <style>
    :root{--bg:#0f1724;--card:#0b1220;--muted:#9aa4b2;--accent:#7c5cff;--glass:rgba(255,255,255,0.04)}
    [data-theme="light"]{--bg:#f4f7fb;--card:#ffffff;--muted:#6b7280;--accent:#6b21a8;--glass:rgba(0,0,0,0.03)}
    *{box-sizing:border-box}body{margin:0;font-family:Inter,ui-sans-serif,system-ui,-apple-system,"Segoe UI",Roboto,"Helvetica Neue",Arial;color:var(--muted);background:linear-gradient(180deg,var(--bg),#031024);min-height:100vh;display:flex;align-items:center;justify-content:center;padding:24px}
    .app{width:100%;max-width:1100px;background:linear-gradient(180deg,rgba(255,255,255,0.02),transparent);border-radius:16px;overflow:hidden;display:grid;grid-template-columns:320px 1fr;gap:0;box-shadow:0 8px 30px rgba(2,6,23,0.6)}
    .sidebar{background:var(--card);padding:18px;display:flex;flex-direction:column;gap:12px}
    .brand{font-weight:700;color:var(--accent);font-size:18px}
    .controls{display:flex;gap:8px;align-items:center}
    .input,button,select{padding:10px 12px;border-radius:10px;border:1px solid rgba(255,255,255,0.04);background:var(--glass);color:inherit}
    .rooms{margin-top:8px;display:flex;flex-direction:column;gap:8px;overflow:auto;padding-right:6px}
    .room{padding:10px;border-radius:10px;cursor:pointer;background:transparent;transition:all .18s;border:1px solid transparent}
    .room.active{background:linear-gradient(90deg,rgba(124,92,255,0.12),rgba(124,92,255,0.04));border-color:rgba(124,92,255,0.18);color:var(--accent)}
    .main{display:flex;flex-direction:column;height:720px;background:linear-gradient(180deg,rgba(255,255,255,0.01),transparent);}
    .header{padding:18px;border-bottom:1px solid rgba(255,255,255,0.02);display:flex;justify-content:space-between;align-items:center}
    .messages{flex:1;padding:18px;overflow:auto;display:flex;flex-direction:column;gap:10px;background:linear-gradient(180deg,transparent,rgba(0,0,0,0.02));}
    .message{max-width:70%;padding:12px;border-radius:12px;background:rgba(255,255,255,0.02);backdrop-filter:blur(4px);}
    .message.me{margin-left:auto;background:linear-gradient(90deg,var(--accent),#5b3bdb);color:white}
    .meta{font-size:12px;color:var(--muted);}
    .composer{padding:16px;border-top:1px solid rgba(255,255,255,0.02);display:flex;gap:8px}
    .composer textarea{flex:1;border-radius:10px;padding:10px;border:1px solid rgba(255,255,255,0.03);min-height:46px;background:transparent;color:inherit;resize:none}
    .small{font-size:13px;color:var(--muted)}
    @media (max-width:900px){.app{grid-template-columns:1fr;height:100vh;border-radius:0}.sidebar{display:none}}
  </style>
</head>
<body data-theme="dark">
  <div class="app" role="application">
    <aside class="sidebar">
      <div class="brand">Realtime Group Chat</div>
      <div class="small">„Éã„ÉÉ„ÇØ„Éç„Éº„É†</div>
      <div style="display:flex;gap:8px">
        <input id="nameInput" class="input" placeholder="Your name" />
        <button id="toggleTheme" class="input" title="Toggle theme">üåì</button>
      </div>

      <div class="small">„É´„Éº„É†</div>
      <div style="display:flex;gap:8px">
        <input id="roomInput" class="input" placeholder="room-id (e.g. general)" value="general" />
        <button id="joinBtn" class="input">Join</button>
      </div>

      <div class="small">ÂèÇÂä†‰∏≠„ÅÆ„É´„Éº„É†</div>
      <div id="rooms" class="rooms"></div>
    </aside>

    <main class="main">
      <div class="header">
        <div>
          <div id="roomTitle" style="font-weight:700;color:var(--accent)"># general</div>
          <div id="roomSubtitle" class="small">Realtime chat powered by Firestore</div>
        </div>
        <div class="small">„Ç™„É≥„É©„Ç§„É≥: <span id="onlineCount">‚Äî</span></div>
      </div>

      <div id="messages" class="messages" aria-live="polite"></div>

      <div class="composer">
        <textarea id="messageInput" placeholder="„É°„ÉÉ„Çª„Éº„Ç∏„ÇíÂÖ•Âäõ... (Shift+Enter„ÅßÊîπË°å)"></textarea>
        <button id="sendBtn" class="input">Send</button>
      </div>
    </main>
  </div>

  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyB-bewCXkSL0tjXl92N_Sdx5eZ04hLTVEE",
      authDomain: "wc-private.firebaseapp.com",
      projectId: "wc-private",
      storageBucket: "wc-private.firebasestorage.app",
      messagingSenderId: "980523258704",
      appId: "1:980523258704:web:1d7861cf80f66d56fb1255",
      measurementId: "G-DMM49XMWSX"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    const nameInput = document.getElementById('nameInput');
    const roomInput = document.getElementById('roomInput');
    const joinBtn = document.getElementById('joinBtn');
    const roomsEl = document.getElementById('rooms');
    const roomTitle = document.getElementById('roomTitle');
    const messagesEl = document.getElementById('messages');
    const messageInput = document.getElementById('messageInput');
    const sendBtn = document.getElementById('sendBtn');
    const onlineCount = document.getElementById('onlineCount');
    const toggleTheme = document.getElementById('toggleTheme');

    let currentRoom = 'general';
    let name = localStorage.getItem('chat_name') || ('User' + Math.floor(Math.random()*900+100));
    nameInput.value = name;

    function timeFmt(ts){ if(!ts) return ''; const d = ts.toDate(); return d.toLocaleTimeString(); }
    function el(tag, cls, txt){ const e=document.createElement(tag); if(cls) e.className=cls; if(txt!==undefined) e.textContent=txt; return e }

    let unsubscribeMessages = null;
    let unsubscribePresence = null;

    async function joinRoom(roomId){
      if(unsubscribeMessages) unsubscribeMessages();
      if(unsubscribePresence) unsubscribePresence();
      currentRoom = roomId;
      roomTitle.textContent = '#' + roomId;
      messagesEl.innerHTML = '';

      const messagesRef = db.collection('rooms').doc(roomId).collection('messages').orderBy('createdAt');
      unsubscribeMessages = messagesRef.onSnapshot(snapshot => {
        snapshot.docChanges().forEach(change => {
          if(change.type === 'added') renderMessage(change.doc.data());
        });
        messagesEl.scrollTop = messagesEl.scrollHeight;
      });

      const presenceDoc = db.collection('rooms').doc(roomId).collection('presence').doc(name);
      await presenceDoc.set({name, lastSeen: firebase.firestore.FieldValue.serverTimestamp()});
      unsubscribePresence = db.collection('rooms').doc(roomId).collection('presence').onSnapshot(snap => {
        onlineCount.textContent = snap.docs.length;
        refreshRoomsList();
      });

      const ping = () => presenceDoc.update({lastSeen: firebase.firestore.FieldValue.serverTimestamp()}).catch(()=>{});
      ping();
      const pingInterval = setInterval(ping, 15000);
      window.addEventListener('beforeunload', ()=>{clearInterval(pingInterval); presenceDoc.delete().catch(()=>{});});
    }

    function renderMessage(data){
      const mine = data.name === name;
      const wrapper = el('div', 'message' + (mine? ' me':''));
      const meta = el('div','meta', `${data.name} ¬∑ ${timeFmt(data.createdAt)}`);
      const text = el('div','', data.text || '');
      wrapper.appendChild(meta);
      wrapper.appendChild(text);
      messagesEl.appendChild(wrapper);
    }

    async function sendMessage(){
      const text = messageInput.value.trim();
      if(!text) return;
      sendBtn.disabled = true;
      const col = db.collection('rooms').doc(currentRoom).collection('messages');
      await col.add({name, text, createdAt: firebase.firestore.FieldValue.serverTimestamp()});
      messageInput.value = '';
      sendBtn.disabled = false;
    }

    async function refreshRoomsList(){
      const roomsRef = db.collection('rooms').orderBy('createdAt','desc').limit(12);
      const snap = await roomsRef.get();
      roomsEl.innerHTML = '';
      const seen = new Set();
      const addRoomItem = (id)=>{
        if(seen.has(id)) return; seen.add(id);
        const r = el('div','room'+(id===currentRoom? ' active':''));
        r.textContent = '#' + id;
        r.onclick = ()=>{ roomInput.value=id; joinBtn.click(); };
        roomsEl.appendChild(r);
      }
      addRoomItem(currentRoom);
      snap.forEach(doc=> addRoomItem(doc.id));
    }

    async function ensureRoomDoc(roomId){
      const doc = db.collection('rooms').doc(roomId);
      const snapshot = await doc.get();
      if(!snapshot.exists) await doc.set({createdAt: firebase.firestore.FieldValue.serverTimestamp(), createdBy: name});
    }

    joinBtn.addEventListener('click', async ()=>{
      name = nameInput.value.trim() || name;
      localStorage.setItem('chat_name', name);
      const r = roomInput.value.trim() || 'general';
      await ensureRoomDoc(r);
      joinRoom(r);
    });

    sendBtn.addEventListener('click', sendMessage);
    messageInput.addEventListener('keydown', (e)=>{
      if(e.key === 'Enter' && !e.shiftKey){ e.preventDefault(); sendMessage(); }
    });

    toggleTheme.addEventListener('click', ()=>{
      const el = document.body;
      const t = el.getAttribute('data-theme') === 'dark' ? 'light' : 'dark';
      el.setAttribute('data-theme', t);
    });

    (async ()=>{ await ensureRoomDoc(currentRoom); joinRoom(currentRoom); refreshRoomsList(); })();
  </script>
</body>
</html>
